# 学生行为数据处理步骤

> 1. 建立密码表
```sql
CREATE TABLE UID_PASSWORD(
	ID SERIAL PRIMARY KEY,
	UID VARCHAR(32) NOT NULL,
	PASSWORD VARCHAR(128) NOT NULL
);
```

> 2. 从远程数据库导入DRCOM密码数据（学术研究所需，数据严格保密）
```bash
python detabase.py
```

> 3. 建立历史登陆数据表
```sql
CREATE TABLE USER_LOGIN_HISTORY(
	ID SERIAL PRIMARY KEY,
	UID VARCHAR(32),
	LOGIN_TIME timestamp not null,
	LOGOUT_TIME timestamp not null,
	DURATION INT NOT NULL,
	USAGE_FLOW FLOAT NOT NULL,
	SOURCE_IP CIDR NOT NULL
);
```

> 4. 从DRCOM网站下载所有人的登陆历史记录
```bash
python login_history_downloader.py
```

> 5. 为USER_LOGIN_HISTORY建立索引
```sql
CREATE INDEX IDX_HISTORY_UID ON USER_LOGIN_HISTORY (UID);
CREATE INDEX IDX_HISTORY_SOURCE_IP ON USER_LOGIN_HISTORY (SOURCE_IP);
```

> 6. 检查USER_LOGIN_HISTORY数据是否可靠无重复
```sql
-- 若有结果，请删除出现的学号的数据并单线程重新导入
SELECT
	A.UID
FROM
	(SELECT * FROM USER_LOGIN_HISTORY) A,
	USER_LOGIN_HISTORY B
WHERE
	  A.UID = B.UID
AND A.LOGIN_TIME = B.LOGIN_TIME
AND A.LOGOUT_TIME = B.LOGOUT_TIME
AND A.DURATION = B.DURATION
AND A.USAGE_FLOW = B.USAGE_FLOW
AND A.SOURCE_IP = B.SOURCE_IP
AND A.ID != B.ID
GROUP BY
    A.UID
```

> 7. 导入小偲OPENID用户表

> 8. 为小偲OPENID用户表建立索引
```sql
CREATE INDEX IDX_USER_OPENID_UID ON USER_OPENID (UID);
```
> 9. 导入小偲微信地理位置表

> 10. 为小偲微信地理位置表DROP无用列和建立索引
```sql
ALTER TABLE USER_LOCATION DROP PLATFORM_ID;
ALTER TABLE USER_LOCATION DROP ADDRESS;
ALTER TABLE USER_LOCATION DROP COUNTRY;
ALTER TABLE USER_LOCATION DROP PROVINCE;
ALTER TABLE USER_LOCATION DROP DISTRICT;
ALTER TABLE USER_LOCATION DROP CITY;
ALTER TABLE USER_LOCATION DROP DESCRIPTION;

CREATE INDEX IDX_USER_LOCALTION_OPENID ON USER_LOCATION (OPENID);
CREATE INDEX IDX_USER_LOCALTION_ID ON USER_LOCATION (ID);
```

> 11. 清理小偲微信地理位置无效数据
```bash
python clear_user_location.py
```

> 12. 建立WI-FI AP的地理位置分析表
```sql
CREATE TABLE AP_GPS_PINS(
	ID SERIAL PRIMARY KEY,
	SOURCE_IP CIDR NOT NULL,
	LONGITUDE FLOAT NOT NULL,
	LATITUDE FLOAT NOT NULL,
	RECORD_TIME timestamp not null
);
```

> 13. 分析AP位置并导入数据
```bash
python AP_analyze.py
```

> 14. 为AP_GPS_PINS建立索引
```sql
CREATE INDEX IDX_AP_GPS_PINS_SOURCE_IP ON AP_GPS_PINS (SOURCE_IP);
```





> xx. 通过此句决定AP地理位置分析优先级
```sql
SELECT
	SOURCE_IP,
FROM
	USER_LOGIN_HISTORY
GROUP BY
	SOURCE_IP
ORDER BY
	COUNT(SOURCE_IP) DESC,
	SUM(LOGOUT_TIME - LOGIN_TIME) DESC
```